---
- name: Bootstrap Argo CD
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../vars/sensitive.yml
    - ../vars/argocd.yml
  vars:
    kubeconfig: "{{ argocd_kubeconfig }}"
    gitops_path: "{{ gitops_repo_path }}/clusters/dev/apps/argo-cd"

  tasks:
    - name: Verify GitOps repo values.yaml exists
      stat:
        path: "{{ gitops_path }}/values.yaml"
      register: values_file

    - name: Fail if values.yaml does not exist
      fail:
        msg: "values.yaml not found at {{ gitops_path }}/values.yaml. Please ensure the GitOps repository is properly configured."
      when: not values_file.stat.exists

    - name: Create argocd namespace
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ argocd_namespace }}"

    - name: Add Helm repo
      kubernetes.core.helm_repository:
        name: "{{ argocd_helm_repo_name }}"
        repo_url: "{{ argocd_helm_repo_url }}"

    - name: Create temp directory for rendered manifests
      tempfile:
        state: directory
        suffix: argocd
        mode: 0700
      register: temp_dir

    - name: Render Argo CD Helm templates
      command: >
        helm template {{ argocd_release_name }}
        {{ argocd_helm_repo_name }}/{{ argocd_chart_name }}
        --version {{ argocd_chart_version }}
        --namespace {{ argocd_namespace }}
        --include-crds
        --values {{ gitops_path }}/values.yaml
        --output-dir {{ temp_dir.path }}

    - name: Find all rendered manifest files
      find:
        paths: "{{ temp_dir.path }}"
        patterns: "*.yaml"
        recurse: yes
      register: manifest_files

    - name: Apply rendered manifests
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ item.path }}"
      loop: "{{ manifest_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Cleanup temp directory
      file:
        path: "{{ temp_dir.path }}"
        state: absent

    - name: Wait for Argo CD server to be ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: "{{ argocd_namespace }}"
        name: "{{ argocd_release_name }}-argocd-server"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    - name: Verify root-app.yaml exists
      stat:
        path: "{{ gitops_repo_path }}/clusters/dev/root-app.yaml"
      register: root_app_file

    - name: Fail if root-app.yaml does not exist
      fail:
        msg: "root-app.yaml not found at {{ gitops_repo_path }}/clusters/dev/root-app.yaml. Please ensure the GitOps repository is properly configured."
      when: not root_app_file.stat.exists

    - name: Apply root Application
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ gitops_repo_path }}/clusters/dev/root-app.yaml"

    - name: Display admin password retrieval command
      debug:
        msg: "Get password: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
